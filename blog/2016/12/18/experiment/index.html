
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Controlled Experiments - Dong Guo's Blog</title>
  <meta name="author" content="Dong Guo">

  
  <meta name="description" content="越来越多人和公司认同data-drivern决策的必要性，不仅是滴滴、Google、Microsoft、Linkedin、Amazon这些科技公司，也包括传统意义上的非技术公司。Data-drivern的核心是Controlled experiment（即大家常说的A/B Testing)， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dongguo.me/blog/2016/12/18/experiment">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Dong Guo's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Dong Guo's Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dongguo.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Controlled Experiments</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-18T23:29:32+08:00" pubdate data-updated="true">Dec 18<span>th</span>, 2016</time>
        
        
           | <a href="#comments">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>越来越多人和公司认同data-drivern决策的必要性，不仅是滴滴、Google、Microsoft、Linkedin、Amazon这些科技公司，也包括传统意义上的非技术公司。Data-drivern的核心是Controlled experiment（即大家常说的A/B Testing)，按照字面理解就是将其它影响因素都control住，保持一致，实验结果只由预设的不同方案影响。</p>

<p>在滴滴算法团队，很多时间和精力都在做各种策略和算法实验，比如我们比较不同的订单分配策略哪个可以让接驾时间更短，比如评估新的动态定价策略对乘客的留存和活跃度有什么样的影响。基于近期在做实验方面遇到的一些挑战思考，以及上个周末看的几篇文章写一个小结在这里。先介绍几个controlled experiment相关的基础而重要的点，总结做controlled experiment中的一些遇到的难点和挑战，最后是一些实验方案和架构的构想（大多是Google和Microsoft等公司的经验）。</p>

<h3>1. 几个基础&amp;重要的知识点</h3>

<h4>1.1. A/A Testing</h4>

<h4>1.2. Hypothesis Testing</h4>

<h4>1.3. Sociation or Causality</h4>

<h3>2. 做Controlled experiment容易犯的错误以及挑战</h3>

<p>通过AB测试产出正确的决策通常是一件非常不容易的事情，我可以很容易列举10条常见的错误导致产出错误的结论。错误的结论包括false postive（新方案无效或者有负向效果，但通过实验得出有效的结论）和false negtative（新方案有效果，但是通过实验判定无效），其中false postive相比false negative对公司上海可能更大。常见的观点是在科技公司的算法和策略优化中，80%~90%的idea被验证是无效或者有负向效果的（见Microsoft这篇文章【3】的5.1小节）</p>

<h4>2.1. 几条典型的产出错误结论的原因</h4>

<ol>
<li>AB流量划分不随机：比如用用户ID最后一位数字做分流，事后才发现该ID并不随机。可通过对数据源深入了解分析和AA测试来减少这方面的错误</li>
<li>AB流量划分随机，但是control或treatement会影响对方的流量，导致对比结果的不可信</li>
<li>错误的指标选取：比如有时业务指标（KPI）很难量化，选择的“近似”可量化的指标实际相比业务指标差很远</li>
<li>实验结果未达到足够的置信度就宣布结论：看p-value，多break down指标看细节</li>
<li>线下线上分流没有对齐：实验设计、代码开发、指标选取都没有问题，但是由于离线用日志评估结果时未使用和线上一致的分流方案（典型的原因是没有将分流标志写入日志，离线只能按照口头约定的逻辑重新实现分流逻辑，常发生在开发和指标统计不是一个团队时），必然导致统计结果有偏差</li>
<li>实验期间外部因素干扰了实验结果，比如天气或特殊事件</li>
<li>任何一个环节的bug</li>
<li>实验本身很完美，但是你的（或者老板给你定的）KPI错了</li>
</ol>


<h4>2.2. 难点1：设计合适的AB流量划分方案</h4>

<p>常见的流量划分方法有这么几种：按照某种ID进行随机划分（比如用户ID、session ID、cookie ID），按照时间片进行划分（比如每半个小时进行算法的轮换）、按照地理区域划分（比如将城市划分成网格，交错apply不同的算法）。</p>

<p>AB流量划分的第一点是保证划分的随机性，通过做AA测试分析基本可以保证。第二点是保证control/treatment不影响对方的流量，对于某些实验上面几种典型的流量划分方案就不可行了。假设滴滴要评估一个新的定价策略是否可以提高GMV，我们看下这几种流量划分方案：</p>

<ol>
<li>按照乘客或者订单ID随机划分：订单分配算法是全局的，所以运力/司机是2个定价策略共享的</li>
<li>按照时间片进行划分轮换：在当前时间片apply某个定价策略，可能会占用下个时间片的运力，特别是时间片较短时（比如不足一小时）影响显著，但是时间片越大时间本身引入的外界因素干扰就越大（比如不同时段的需求、运力、天气等因素的差异）</li>
<li>按照地理区域划分：同样有运力共享的问题</li>
</ol>


<p>对于这个case，如果你有好的流量划分idea非常欢迎和我交流</p>

<h4>2.3. 难点2：想清楚本质的业务目标，而不只是关注短期指标</h4>

<h4>2.4. 难点3：在较短时间(如几天/周)内得出长期指标的结论</h4>

<p>通过假设检验可以判断实验结论的置信度，不过业务指标往往都是长期的，比如用户的长期留存和活跃度。
Google在这边</p>

<p>预测的方法；
google的paper
区分</p>

<ol>
<li>设计一个可靠的AB测试方案</li>
<li>在较短的时间内（比如几天或者几周）内得出结论</li>
<li>确定一个比较好的
设计
一个靠谱的controlled实验方案（AA测试验证、互相干扰、需要很长时间）</li>
<li>决定是否能够得出确定的结论（实验本身需要验证长期影响，系统波动性vs随机波动，google的文章 不应仅关注短期metric，）</li>
<li>确定最符合业务的实验评估metric （正确的KPI，短期metrc与长期metric）</li>
</ol>


<h3>3. 实验平台</h3>

<p>更大的层面</p>

<ol>
<li>统一的实验平台：提高公司层面做实验的效率和可靠性（避免未协调的实验冲突、流量管理、方便非技术人员操作实验、实验实时监控和报警）</li>
<li>架构支持overlapping：分domain、layer的流量划分</li>
<li>实验评审与共享：评审/Review实验设置的可靠性、分享实验解决(stand on others&#8217; shoulders)</li>
</ol>


<p>几个topic</p>

<ol>
<li>长期影响实验设计、通过短期预测长期（google的实验）</li>
<li>正交</li>
</ol>


<p>在滴滴做实验</p>

<p>保证实验的效率，实验的可靠性，AB测试结果的可靠性是非常难的事情</p>

<h3>Reference</h3>

<ol>
<li><a href="http://research.google.com/pubs/archive/43887.pdf">Focusing on the Long-term: It’s Good for Users and Business</a> KDD2015</li>
<li><a href="http://static.googleusercontent.com/external_content/untrusted_dlcp/research.google.com/en/us/pubs/archive/36500.pdf">Overlapping Experiment Infrastructure: More, Better, Faster Experimentation</a> KDD2010</li>
<li><a href="http://ai.stanford.edu/~ronnyk/ExPThinkWeek2009Public.pdf">Online Experimentation at Microsoft</a> 2009</li>
</ol>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dong Guo</span></span>

      








  


<time datetime="2016-12-18T23:29:32+08:00" pubdate data-updated="true">Dec 18<span>th</span>, 2016</time>
      


    </p>
    
      <div class="sharing">
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/12/06/archsummit2016/" title="Previous Post: ArchSummit2016干货分享">&laquo; ArchSummit2016干货分享</a>
      
      
    </p>
  </footer>
</article>


  <section>
    <h1>Comments</h1>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
    var duoshuoQuery = {short_name:"guod08"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END -->
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Dong Guo</h1>
  <p>滴滴打车-算法专家 (策略设计|机器学习|优化方法). 
  <br></br>Previously at Hulu and Baidu. Graduated from Tsinghua University.
  <br></br>
  Email: guod08[at]gmail.com<br> 
  <a href="http://www.linkedin.com/in/dongguo1">Linkedin</a>, <a href="https://github.com/guod08/">Github</a>, <a href="http://www.slideshare.net/guo_dong">SlideShare</a> </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/12/18/experiment/">Controlled Experiments</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/06/archsummit2016/">ArchSummit2016干货分享</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/03/future-transportation/">出行的未来</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/13/ri-ji-2016-02-13-semi-supervised-learning-Reinforcement-learning/">日记2016/02/13:周志华老师的新书</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/25/didi-strategy-team-welcome-you/">滴滴出行-大数据策略组请你加入</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/18/wo-zai-di-di-yu-dao-de-ji-zhu-tiao-zhan/">我在滴滴遇到的技术挑战</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/28/shi-yong-shadowsockske-xue-shang-wang/">使用Shadowsocks科学上网</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/24/what-i-learned-in-my-first-job/">我在第一份工作中学到了什么</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/02/druid-cluster-setup/">Druid Cluster Setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/12/cookies-matching-introduction/">在线广告中的cookie Matching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/30/Spark-Usage-Share/">Spark使用经验分享</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/16/Machine-Learning-talks-from-me/">Slides of Some Machine Learning Talk I Shared in Hulu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/28/programmatic-digital-advertising/">Programmatic Digital Advertising</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/20/ad-inventory-forecasting/">Challenges for a Word-class Ad Inventory Forecasting System</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/05/druid-introduction-and-practise/">Druid介绍与实践</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/01/expectation-propagation/">Expectation Propagation: Theory and Application</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/15/classification-models/">Classification Models</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/02/gaussian-and-truncated-gaussian/">Gaussian and Truncated Gaussian</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/01/bayesian-ctr-prediction-for-bing/">Bayesian CTR Prediction of Bing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/12/distributed-system-theory/">Notes for Distributed System Theory</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/20/shi-jian-guan-li/">更高效地工作学习</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tag Cloud</h1>
  <span id="tag-cloud"><a href='/blog/categories/bayesian' style='font-size: 120.0%'>bayesian(2)</a> <a href='/blog/categories/big-data' style='font-size: 140.0%'>big_data(4)</a> <a href='/blog/categories/career' style='font-size: 120.0%'>career(2)</a> <a href='/blog/categories/computing-ads' style='font-size: 130.0%'>computing_ads(3)</a> <a href='/blog/categories/data-platform' style='font-size: 120.0%'>data_platform(2)</a> <a href='/blog/categories/engineering' style='font-size: 160.0%'>engineering(6)</a> <a href='/blog/categories/machine-learning' style='font-size: 150.0%'>machine_learning(5)</a> <a href='/blog/categories/math' style='font-size: 110.0%'>math(1)</a> <a href='/blog/categories/spark' style='font-size: 110.0%'>spark(1)</a> </span>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Dong Guo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>









</body>
</html>
